const lib = {
    "kaomoji": {
        "sparkles": [
            "✧･ﾟ: *✧･ﾟ:* 　　 *:･ﾟ✧*:･ﾟ✧",
            "*＊✿❀　❀✿＊*"
        ],
        "bears": [
            "ʕ •ᴥ•ʔ",
            "ᶘಠᴥಠᶅ"
        ],
        "cats": [
            "ฅ(＾・ω・＾ฅ)",
            `චᆽච`
        ],
        "dogs": [
            "▼・ᴥ・▼",
            "U・ᴥ・U"
        ],
        "jailed": [
            "||Φ|(|ﾟ|∀|ﾟ|)|Φ||",
            "━━━━||Φ|(|´|Д|`|)|Φ||━━━━"
        ],
        "flower girl": [
            "(　◕‿◕✿)",
            "(◕▽◕✿)"
        ],
        "blushing flower girl": [
            "(˶◕‿◕˶✿)",
            "(⁄ ⁄◕⁄ω⁄◕⁄ ⁄✿)"
        ],
        "sad flower girl": [
            "(◕‸ ◕✿) *pout*",
            "(◕︿◕✿)"
        ],
        "table flipping throwing": [
            "(╯°□°）╯︵ ┻━┻",
            "┻━┻ミ＼(≧ﾛ≦＼)"
        ],
        "bears table flipping throwing": [
            "ʕノ•ᴥ•ʔノ ︵ ┻━┻",
            " ┳┳ヾ(T(エ)Tヽ)"
        ],
        "setting the table": [
            "┬──┬ ノ( ゜-゜ノ)",
            "(ヘ･_･)ヘ┳━┳"
        ],
        "good morning": [
            "(*^｡^*)Rise (*^o^*)And ＼(*^0^*)／Shineｰ!!",
            "(_ _)(-.-)(~O~)*yawn*・・(~O~)(-.-)"
        ],
        "kissing kisses": [
            "( ˘ ³˘)♥",
            "(ɔˆ ³(ˆ⌣ˆc)"
        ],
        "throwing kisssing kisses": [
            "★⌒ヽ(●’､＾●)Kiss!",
            "(^з^)-☆Chu!!"
        ],
        "hugs hugging": [
            "(つ・▽・)つ⊂(・▽・⊂)",
            "(つ≧▽≦)つ⊂(・ヮ・⊂)"
        ],
        "mad": [
            "┗(｀Дﾟ┗(｀ﾟДﾟ´)┛ﾟД´)┛",
            "!!!!|┛*｀Д´|┛・・~~┻━┻　┳━┳"
        ],
        "pigs": [
            "(´・(oo)・｀)",
            "(V´・(oo)・｀V)"
        ],
        "deep crying face": [
            "ಥ_ಥ",
            "ಥ╭╮ಥ"
        ],
        "denko shoboon": [
            "(´・ω・｀)",
            "Σ(´・ω・｀)"
        ],
        "raise your dongers": [
            "ヽ༼ຈل͜ຈ༽ﾉ",
            "✺◟༼ຈ ل͜ ຈ༽◞✺"
        ],
        "strolling happy gary": [
            "ᕕ( ᐛ )ᕗ",
            "ᐠ( ᐛ )ᐟ"
        ],
        "it’s here kitaaa": [
            "ｷﾀ━(ﾟ∀ﾟ)━!",
            "ｷﾀ━━━(Дﾟ(○=(ﾟ∀ﾟ)=○)Дﾟ)━━━!!"
        ],
        "laughing": [
            "(´∀｀)",
            "ヽ（´∀｀）ノ"
        ],
        "lenny face": [
            "( ͡° ͜ʖ ͡°)",
            "ᕦ( ͡° ͜ʖ ͡°)ᕤ"
        ],
        "look of disapproval": [
            "ಠ_ಠ",
            "ლ(ಠ益ಠლ)"
        ],
        "shrug": [
            `¯\\\_(ツ)_/¯`,
            `¯\\\_㋡_/¯`
        ],
        "smiling": [
            "（＾－＾）",
            "（＾O＾）"
        ],
        "smug face": [
            "ಸ‿ಸ",
            "ಇ(ಸ‿ಸ)ಇ"
        ],
        "cheerful": [
            "(❁´◡`❁)",
            "ヾ(＠^∇^＠)ノ"
        ],
        "excited": [
            "✧ ─=≡Σ((( つ•̀ω•́)つ",
            "✖‿✖"
        ],
        "blushing flattered": [
            "(〃 ω 〃)",
            "‧⁺( ᵒ̴̶̷̥́ ◡ ᵒ̴̶̷̣̥̀ )⁺‧"
        ],
        "sad crying": [
            "o（ｉДｉ）o",
            "˚‧º·(˚ ˃̣̣̥⌓˂̣̣̥ )‧º·˚"
        ],
        "sad depressed": [
            "(◞ ‸ ◟ㆀ)",
            "(╯︵╰)"
        ],
        "weird awkward": [
            "( ་ ⍸ ་ )",
            "(　☉д⊙)"
        ],
        "weird creepy": [
            "(´⊙◞⊱​◟⊙｀)​",
            "(´◉◞⊖◟◉｀)"
        ],
        "weird wtf gross": [
            "༼;´༎ຶ ۝ ༎ຶ༽",
            "(◞≼⓪≽◟⋌⋚⋛⋋◞≼⓪≽)"
        ],
        "weird hide stalkerific": [
            "|ω・)",
            "┬┴┬┴┤(･_├┬┴┬┴"
        ]
    },
    "nameMap": {
        // eslint-disable-line
    },
    "nameArr": [
        // eslint-disable-line
    ]
}

//     (╯°□°）╯ logics*:

_.forEach(lib.kaomoji, (kaomoji, fullName) => {
    _.forEach(fullName.split(" "), partiallyName => {
        while (lib.nameMap[partiallyName]) {
            partiallyName = `_${partiallyName}`
        }
        lib.nameMap[partiallyName] = fullName
        lib.nameArr.push(partiallyName)
    })
})

const kaomoji = lib.kaomoji
const nameMap = lib.nameMap
const nameArr = lib.nameArr
let suggestionsTurnOff = false

$(document).ready(() => {
    const inputPopup = initHelper('Kaomoji Typer')
    inputPopup.hide()
    $('.ui-button-icon.ui-icon.ui-icon-closethick').on('click', () => {
        $(".suggestions").html("")
        inputPopup.remove()
        suggestionsTurnOff = true
    })

    let listenedDomCache

    (function checkNewDom () {
        const currentDom = $('textarea, input')
        const newDom = _.difference(currentDom, listenedDomCache, suggestionsTurnOff)
        if (newDom && newDom.length > 0) addListenEvent(inputPopup, newDom)
        listenedDomCache = currentDom
        setTimeout(checkNewDom, 3000)
    })()

    const originalTop = $('.ui-dialog').offset().top
    $(window).scroll(function () {
        $('.ui-dialog').css('top', originalTop + $(this).scrollTop())
    })
})

let suggestedKaomojis = []

function getSuggestions (lastWord) {
    lastWord = lastWord.toLowerCase()
    let matchingKaomojis = []
    if (kaomoji[lastWord]) matchingKaomojis = _.union(matchingKaomojis, kaomoji[lastWord])
    if (nameMap[lastWord]) matchingKaomojis = _.union(matchingKaomojis, kaomoji[nameMap[lastWord]])
    _.forEach(nameArr, name => {
        if (name.includes(lastWord)) {
            matchingKaomojis = _.union(matchingKaomojis, kaomoji[nameMap[name]])
        }
    })

    return matchingKaomojis
}

function addListenEvent (inputPopup, newDom) {
    $(newDom).on('input selectionchange propertychange', function (e) {
        if (this.type === "password") return
        const allWords = $(this).val().split(/\s/)
        const lastWord = allWords.pop()
        const lastWordLength = lastWord.length
        if (suggestionsTurnOff) {
        } else if (lastWordLength === 0) {
            inputPopup.hide()
            $(".suggestions").html("")
        } else if (lastWordLength > 1) {
            const lastChar = lastWord.charAt(lastWordLength - 1)
            if (lastChar > 0 && lastChar <= suggestedKaomojis.length) {
                $(this).val(`${allWords} ${suggestedKaomojis[lastChar - 1]} `)
                inputPopup.hide()
                $(".suggestions").html("")
            } else {
                updateDropDown(this, allWords, lastWord)
            }
        } else {
            openNewDropDown(this, allWords)
            inputPopup.show()
            updateDropDown(this, allWords, lastWord) // get suggestions when only one char is typed or not?
        }
    })
}

function updateDropDown (el, allWords, lastWord) {
    suggestedKaomojis = getSuggestions (lastWord)
    let innerHtml = "<div><p class='tip'>No need to click. Just type 1-9</p>"
    _.forEach(suggestedKaomojis, (kaomoji, index) => {
        if (index < 9) innerHtml += "<span>" + (index + 1) + ". " + kaomoji + "</span><br />"
    })
    innerHtml += "</div>"

    $(".suggestions").html(innerHtml)
    $('.tip').hide()
    $('.ui-dialog.ui-corner-all.ui-widget.ui-widget-content.ui-front.ui-draggable.ui-resizable').hover(() => {
        $('.tip').show()
        $('.tip').stop()
        $('.tip').fadeIn(1)
    }, () => {
        setTimeout(() => {
            $('.tip').fadeOut(1500)
        }, 500)
    })
}

function openNewDropDown (el) {
    $(".suggestions").show()
}

function initHelper (title) {
    $("body").append(`
            <div class="suggestions"></div>
        `)
    $(".suggestions").dialog()
    $("span.ui-dialog-title").text(title)

    return $('.ui-dialog.ui-corner-all.ui-widget.ui-widget-content.ui-front.ui-draggable.ui-resizable')
}
